<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      AFRAME.registerComponent('markerhandler', {
        schema: {
          arobject: {type: 'selector'},
        },
        init: function () {
          // マーカーの検出とロストの状態を管理する変数を定義、初期値はfalse
          this.isTracking = false;
          // markerFoundはマーカー検出時に呼び出される
          this.el.addEventListener('markerFound', () => {
            this.isTracking = true;
            console.log(`Tracking: ${this.isTracking}`);
          });
          // markerLostはマーカーがロストした時に呼び出される
          this.el.addEventListener('markerLost', () => {
            this.isTracking = false;
            console.log(`Tracking: ${this.isTracking}`);
          });
        },
        tick: function (time, timeDelta) {
          // もしマーカーが認識されていれば
          if (this.isTracking) {
            // このスクリプトが適用されているオブジェクトを取得
            const marker = this.el.object3D;
            // マーカーの位置を取得
            const markerPosition = this.el.object3D.position;
            const p = new THREE.Vector3();
            marker.getWorldPosition(p);
            // マーカーの姿勢を取得
            const q = new THREE.Quaternion();
            marker.getWorldQuaternion(q);
            const markerRotation = this.el.object3D.rotation;
            // オブジェクトの位置、姿勢を反映
            const obj = this.data.arobject.object3D;
            obj.position.set(p.x, p.y, p.z);
            obj.quaternion.set(q.x, q.y, q.z, q.w);
            // マーカーの位置をオブジェクトの位置に設定
            this.data.arobject.object3D.position.set(markerPosition.x, markerPosition.y, markerPosition.z);
            // マーカーの回転をオブジェクトの回転に設定
            this.data.arobject.object3D.rotation.set(markerRotation.x, markerRotation.y, markerRotation.z);
          }
          
        }
      });
    </script>
  </head>
  <body>
    <a-scene embedded arjs>
      <a-marker markerhandler="arobjects:#ar-objects" preset="hiro">
        <a-sphere position="0 1.25 0" radius="1.25" shadow src="https://cdn.glitch.global/f79e5079-e820-4ab3-956a-053a01cba8ad/earth.jpg?v=1672322191934"
                  animation="
                             property:rotation;
                             dur:10000;
                             from:0 0 0;
                             to:0 360 0;
                             loop:-1;
                             easing:linear;
                             "
                  ></a-sphere>
      </a-marker>
      <a-entity camera id="ar-objects">
      </a-entity>
    </a-scene>
  </body>
</html>